<!doctype html>
<html>

<head>
	<!doctype html>
	<html>

	<head>
		<meta charset="utf-8">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>教学管理驾驶舱</title>
		<link type="text/css" href="css/public.css" rel="stylesheet">
		<link type="text/css" href="css/index.css" rel="stylesheet">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 768 * 100 + 'px';
		</script>

		<script src="https://www.jq22.com/jquery/echarts-4.2.1.min.js"></script>
	</head>
	<style>
		.abc {}
	</style>

<body>
	<div class="bg">
		<div class="title">教学管理驾驶舱</div>
		<div class="leftMain">
			<div class="leftMain_top">
				<div class="leftMain_topIn">
					<ul>
						<li>
							<div class="liIn">
								<h3>学生人数</h3>
								<p class="shu"><span class="shu1"></span><i>人</i></p>
								<span class="border_bg_leftTop"></span>
								<span class="border_bg_rightTop"></span>
								<span class="border_bg_leftBottom"></span>
								<span class="border_bg_rightBottom"></span>
							</div>
						</li>
						<li>
							<div class="liIn">
								<h3>教师人数</h3>
								<p class="shu"><span class="shu2"></span><i>人</i></p>
								<span class="border_bg_leftTop"></span>
								<span class="border_bg_rightTop"></span>
								<span class="border_bg_leftBottom"></span>
								<span class="border_bg_rightBottom"></span>
							</div>
						</li>
						<li>
							<div class="liIn">
								<h3>课程门数</h3>
								<p class="shu"><span class="shu3"></span><i>门</i></p>
								<span class="border_bg_leftTop"></span>
								<span class="border_bg_rightTop"></span>
								<span class="border_bg_leftBottom"></span>
								<span class="border_bg_rightBottom"></span>
							</div>
						</li>
						<li>
							<div class="liIn">
								<h3>开课总数</h3>
								<p class="shu"><span class="shu4"></span><i>门</i></p>
								<span class="border_bg_leftTop"></span>
								<span class="border_bg_rightTop"></span>
								<span class="border_bg_leftBottom"></span>
								<span class="border_bg_rightBottom"></span>
							</div>
						</li>
					</ul>
				</div>
			</div>
			<div class="leftMain_middle">
				<div class="leftMain_middle_left">
					<div class="leftMain_middle_leftIn">
						<h3>课程开课频率</h3>
						<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
						<div class="biaoge" style="width:100%; height:25vh" id="chartmain"></div>
						<span class="border_bg_leftTop"></span>
						<span class="border_bg_rightTop"></span>
						<span class="border_bg_leftBottom"></span>
						<span class="border_bg_rightBottom"></span>
						<span class="border_bg_leftTop"></span>
						<span class="border_bg_rightTop"></span>
						<span class="border_bg_leftBottom"></span>
						<span class="border_bg_rightBottom"></span>
					</div>
				</div>
				<div class="leftMain_middle_right">
					<div class="leftMain_middle_rightIn">
						<h3>异常课程统计</h3>
						<div class="biaoge biaoge_pai" style="width:100%; height:25vh">
							<div class="biaoge_paiIn">
								<ul id="gzlTop5Box"></ul>
							</div>
						</div>
						<span class="border_bg_leftTop"></span>
						<span class="border_bg_rightTop"></span>
						<span class="border_bg_leftBottom"></span>
						<span class="border_bg_rightBottom"></span>
					</div>
				</div>
			</div>
			<div class="leftMain_middle">
				<div class="leftMain_middle_left">
					<div class="leftMain_middle_leftIn">
						<h3>成绩分布</h3>
						<div class="biaoge" style="width:100%; height:25vh" id="chartmain_zhe"></div>
						<span class="border_bg_leftTop"></span>
						<span class="border_bg_rightTop"></span>
						<span class="border_bg_leftBottom"></span>
						<span class="border_bg_rightBottom"></span>
					</div>
				</div>
				<div class="leftMain_middle_right">
					<div class="leftMain_middle_rightIn">
						<h3>学期统计数据</h3>
						<div class="biaoge biaoge_bi" style="width:100%; height:25vh">
							<ul>
								<li>
									<div class="liIn">
										<p class="shu shu5"></p>
										<p class="zi">教师人数</p>
									</div>
								</li>
								<li>
									<div class="liIn">
										<p class="shu shu6"></p>
										<p class="zi">开课门数</p>
									</div>
								</li>
								<li>
									<div class="liIn">
										<p class="shu shu7"></p>
										<p class="zi">选课门数</p>
									</div>
								</li>
								<li>
									<div class="liIn">
										<p class="shu shu8"></p>
										<p class="zi">课/师比</p>
									</div>
								</li>
								<li>
									<div class="liIn">
										<p class="shu shu9"></p>
										<p class="zi">生/课比</p>
									</div>
								</li>
								<li>
									<div class="liIn">
										<p class="shu shu10"></p>
										<p class="zi">异常课数</p>
									</div>
								</li>
							</ul>

						</div>
						<span class="border_bg_leftTop"></span>
						<span class="border_bg_rightTop"></span>
						<span class="border_bg_leftBottom"></span>
						<span class="border_bg_rightBottom"></span>
					</div>
				</div>
			</div>
		</div>
		<div class="rightMain">
			<div class="rightMain_top">
				<div class="rightMain_topIn">
					<h3>课程种类</h3>
					<div class="biaoge" style="width:100%; height:30vh" id="chartmain_bing"></div>
					<span class="border_bg_leftTop"></span>
					<span class="border_bg_rightTop"></span>
					<span class="border_bg_leftBottom"></span>
					<span class="border_bg_rightBottom"></span>
				</div>
			</div>
			<div class="rightMain_bottom">
				<div class="rightMain_bottomIn">
					<h3>成绩排名前50</h3>
					<div class="biaoge biaoge_list" style="width:100%; height:36vh">
						<div class="biaoge_listIn">
							<ul class="ul_title">
								<li>排序</li>
								<li>学号</li>
								<li>姓名</li>
								<li>班级</li>
								<li>总绩点</li>
							</ul>
							<div class="ul_list">
								<div id="pointTop50Box" class="ul_listIn"></div>
							</div>
						</div>

					</div>
					<span class="border_bg_leftTop"></span>
					<span class="border_bg_rightTop"></span>
					<span class="border_bg_leftBottom"></span>
					<span class="border_bg_rightBottom"></span>
				</div>
			</div>
		</div>
		<div style="clear:both;"></div>
	</div>
	<!--数字增长累加动画-->
	<script src="https://www.jq22.com/jquery/jquery-1.10.2.js"></script>
	<script src="js/jquery.numscroll.js" type="text/javascript" charset="utf-8"></script>
	<script src="./js/jquery.cookie.js"></script>
	<script type="text/javascript">
		var dv = {
			scBeginTermIndex: 0,
			scEndTermIndex: 0,
			aeBeginTermIndex: 0,
			aeEndTermIndex: 0,
			theTerm: 20161,

			summaryData: [],
			deptParcentData: [],
			scNumData: [],
			gzlTop5Data: [],
			aePercentData: [],
			theTermInfo: [],
			pointTop50Data: []
		}
		// 呈现数据总览
		function renderSummary() {

			if (!$.isEmptyObject(dv.summaryData)) {
				$(".shu1").text(dv.summaryData["stu_num"]);
				$(".shu2").text(dv.summaryData["teachter_num"]);
				$(".shu3").text(dv.summaryData["coure_num"]);
				$(".shu4").text(dv.summaryData["teaching_num"]);
				$(".shu1").numScroll();
				$(".shu2").numScroll();
				$(".shu3").numScroll();
				$(".shu4").numScroll();
			}
		}
		//呈现课程种类
		function renderDeptParcent() {

			var lengendData = [], seriesData = [];
			if (dv.deptParcentData && dv.deptParcentData.length > 0) {
				dv.deptParcentData.forEach(it => {
					lengendData.push(it.cname);
					seriesData.push({ name: it.cname, value: it.count })
				});
			}
			option = {
				title: {
					text: '数据情况统计',
					subtext: '',
					left: 'right',
					textStyle: {
						color: '#fff',
						fontSize: 12
					}
				},
				tooltip: {
					trigger: 'item',
					formatter: '{a} <br/>{b} : {c} ({d}%)'
				},
				legend: {
					// orient: 'vertical',
					// top: 'middle',
					type: 'scroll',
					orient: 'vertical',
					right: 10,
					top: 40,
					bottom: 20,
					left: 'right',
					data: lengendData,
					textStyle: {
						color: '#fff',
						fontSize: 12
					}

				},
				grid: {
					x: '-10%',
					y: 40,
					x2: 20,
					y2: 20,
				},
				color: ['#09d0fb', '#f88cfb', '#95f8fe', '#f9f390', '#ecfeb7'],
				series: [
					{
						name: "人数占比",
						type: 'pie',
						radius: '65%',
						center: ['50%', '50%'],
						selectedMode: 'single',
						data: seriesData,
						emphasis: {
							itemStyle: {
								shadowBlur: 10,
								shadowOffsetX: 0,
								shadowColor: 'rgba(0, 0, 0, 0.5)'
							}
						}
					}
				]
			};
			//获取dom容器
			var myChart = echarts.init(document.getElementById('chartmain_bing'));
			// 使用刚指定的配置项和数据显示图表。
			myChart.setOption(option);
		}
		function termFormat(trem) {
			var seasons = ['春', '秋'];
			return Math.floor(trem / 10) + seasons[trem % 10]
		}
		function renderTermScNum(endIndex) {
			// 定义默认显示的条数
			var defaultNum = 10;

			if (dv.scNumData && dv.scNumData.length > 0) {
				// 设置数据的起始和结束索引
				dv.scBeginTermIndex = endIndex - defaultNum > 0 ? endIndex - defaultNum + 1 : 0;
				dv.scEndTermIndex = endIndex;

				// 准备数据
				var dataAxis = []; // X 轴的课程名称
				var data = [];     // Y 轴的开课次数
				var yMax = 0;      // Y 轴最大值
				var dataShadow = [];// 阴影背景数据

				for (var i = dv.scBeginTermIndex; i <= dv.scEndTermIndex; i++) {
					// 如果课程名称为空，用“未知课程”填充
					var courseName = dv.scNumData[i].cname || '未知课程';
					dataAxis.push(courseName);
					data.push(dv.scNumData[i].open_times);

					// 更新 Y 轴最大值
					if (dv.scNumData[i].open_times > yMax) {
						yMax = dv.scNumData[i].open_times;
					}
				}

				// 增加 1 作为最大值的偏移
				yMax = yMax + 1;

				// 填充阴影背景数据
				for (var i = 0; i < data.length; i++) {
					dataShadow.push(yMax);
				}

				// 图表配置项
				option = {
					title: {
						text: '',
						subtext: ''
					},
					grid: {
						x: 40,
						y: 40,
						x2: 20,
						y2: 20,
					},
					xAxis: {
						data: dataAxis,
						axisLabel: {
							interval: 0,
							rotate: 45, // 如果课程名称较长，标签旋转 45 度
							textStyle: {
								color: '#fff',
								fontSize: 12
							}
						},
						axisTick: {
							show: false,
						},
						axisLine: {
							show: true,
							symbol: ['none', 'arrow'],
							symbolOffset: 12,
							lineStyle: {
								color: '#fff',
							}
						},
						z: 10
					},
					yAxis: {
						type: 'value',
						name: '开课次数',
						axisLine: {
							show: true,
							symbol: ['none', 'arrow'],
							symbolOffset: 12,
							lineStyle: {
								color: '#fff',
							}
						},
						axisTick: {
							show: false
						},
						axisLabel: {
							textStyle: {
								color: '#fff',
								fontSize: 12
							}
						}
					},
					dataZoom: [
						{
							type: 'inside'
						}
					],
					series: [
						{ // 背景阴影柱子
							type: 'bar',
							itemStyle: {
								color: 'rgba(0,0,0,0.05)'
							},
							barGap: '-100%',
							barCategoryGap: '40%',
							data: dataShadow,
							animation: false
						},
						{ // 数据柱子
							type: 'bar',
							itemStyle: {
								color: new echarts.graphic.LinearGradient(
									0, 0, 0, 1,
									[
										{ offset: 0, color: '#0efdff' },
										{ offset: 0.5, color: '#188df0' },
										{ offset: 1, color: '#188df0' }
									]
								)
							},
							emphasis: {
								itemStyle: {
									color: new echarts.graphic.LinearGradient(
										0, 0, 0, 1,
										[
											{ offset: 0, color: '#2378f7' },
											{ offset: 0.7, color: '#2378f7' },
											{ offset: 1, color: '#0efdff' }
										]
									)
								}
							},
							data: data
						}
					]
				};


				//获取dom容器
				var myChart = echarts.init(document.getElementById('chartmain'));
				// 使用刚指定的配置项和数据显示图表。
				myChart.setOption(option);
				$("#scTermLabel").text(termFormat(dv.scNumData[dv.scBeginTermIndex].cterm) + "至" + termFormat(dv.scNumData[dv.scEndTermIndex].cterm))
			}
		}
		
		function renderGzlTop5() {
			// 定义排行榜的模板
			var theMaxFailRate = 1; // 最大的失败率
			var theWidth = 100; // 百分比宽度
			var template = '<li><div class="liIn">' +
				'<div class="liIn_left"><span class="bot"></span><span class="zi">{cname} (学期: {cterm})</span></div>' +
				'<div class="liIn_line"><div class="line_lineIn" style="width:{theWidth}%;"></div></div>' +
				'<p class="num">{fail_rate}% ({theWidth}%)</p></div></li>';
			var html = '';

			// 判断是否有数据
			if (dv.gzlTop5Data && dv.gzlTop5Data.length > 0) {
				for (var i = 0; i < dv.gzlTop5Data.length; i++) {
					if (i === 0) {
						// 取第一项作为最大失败率
						theMaxFailRate = dv.gzlTop5Data[0].fail_rate;
						theWidth = 100;
					} else {
						// 计算每一项的宽度比例
						theWidth = Math.round(dv.gzlTop5Data[i].fail_rate * 100 / theMaxFailRate);
					}

					// 替换模板中的占位符
					var liHtml = template.replace('{cname}', dv.gzlTop5Data[i].cname);
					liHtml = liHtml.replace('{cterm}', dv.gzlTop5Data[i].cterm);
					liHtml = liHtml.replaceAll('{theWidth}', theWidth);
					liHtml = liHtml.replaceAll('{fail_rate}', dv.gzlTop5Data[i].fail_rate.toFixed(2));
					html += liHtml; // 拼接 HTML
				}
				console.log("html:", html);
				$('#gzlTop5Box').html(html); // 将 HTML 写入到页面中
			}
		}

		function renderAePercent(endIndex) {
			console.log("scoreData:", dv.scoreData);

			// 准备数据
			var xdata = []; // X轴数据：分数范围
			var adata = []; // Y轴数据：人数

			if (dv.scoreData && dv.scoreData.length > 0) {
				for (var i = 0; i < dv.scoreData.length; i++) {
					xdata.push(dv.scoreData[i].score_range); // 分数范围
					adata.push(dv.scoreData[i].count);      // 人数
				}
			}

			// 图表配置
			var option = {
				tooltip: {
					trigger: 'axis',
					formatter: '{b}<br />人数: {c}'
				},
				xAxis: {
					type: 'category',
					boundaryGap: true,
					axisLabel: {
						interval: 0,
						rotate: 45, // 旋转 X 轴标签，防止重叠
						textStyle: {
							color: '#fff',
							fontSize: 12
						}
					},
					axisTick: {
						show: false
					},
					axisLine: {
						show: true,
						symbol: ['none', 'arrow'],
						symbolOffset: 12,
						lineStyle: {
							color: '#fff'
						}
					},
					data: xdata // X 轴数据
				},
				yAxis: {
					type: 'value',
					name: '人数',
					axisLine: {
						show: true,
						symbol: ['none', 'arrow'],
						symbolOffset: 12,
						lineStyle: {
							color: '#fff'
						}
					},
					axisTick: {
						show: false
					},
					axisLabel: {
						textStyle: {
							color: '#fff',
							fontSize: 12
						}
					}
				},
				series: [
					{
						name: '人数',
						type: 'bar',
						barWidth: '50%',
						data: adata,
						itemStyle: {
							normal: {
								color: new echarts.graphic.LinearGradient(
									0, 0, 0, 1,
									[
										{ offset: 0, color: '#0efdff' },
										{ offset: 0.5, color: '#188df0' },
										{ offset: 1, color: '#188df0' }
									]
								)
							}
						}
					}
				]
			};

			var myChart = echarts.init(document.getElementById('chartmain_zhe'));
			myChart.setOption(option);
			$("#aeTermLabel").text(termFormat(dv.scNumData[dv.scBeginTermIndex].cterm) + '至' + termFormat(dv.scNumData[dv.scEndTermIndex].cterm));

		}
		//呈现学期运行数据
		function renderTermInfo() {
			$(".shu5").text(dv.theTermInfo["tnum"]);
			$(".shu6").text(dv.theTermInfo["cnum"]);
			$(".shu7").text(dv.theTermInfo["snum"]);
			$(".shu8").text(dv.theTermInfo["ctr"]);
			$(".shu9").text(dv.theTermInfo["scr"]);
			$(".shu10").text(dv.theTermInfo["ycnum"]);
			$(".shu5").numScroll();
			$(".shu6").numScroll();
			$(".shu7").numScroll();
			$(".shu8").numScroll();
			$(".shu9").numScroll();
			$(".shu10").numScroll();
		}
		//7.呈现成绩排名前50
		function renderSpointTop50() {
			var template = '<ul class="ul_con">' + '<li>{no}</li>' + '<li>{sno}</li>' +
				'<li>{sname}</li>' + '<li>{sclass}</li>' + '<li>{pointSum}</li></ul>';
			var html = '';
			if (dv.pointTop50Data && dv.pointTop50Data.length > 0) {
				for (var i = 0; i < dv.pointTop50Data.length; i++) {
					var liHtml = template.replace('{no}', i + 1);
					liHtml = liHtml.replace('{sno}', dv.pointTop50Data[i].sno);
					liHtml = liHtml.replace('{sname}', dv.pointTop50Data[i].sname);
					liHtml = liHtml.replace('{sclass}', dv.pointTop50Data[i].sclass);
					liHtml = liHtml.replace('{pointSum}', dv.pointTop50Data[i].spoint);
					html += liHtml;
				}
				$('#pointTop50Box').html(html);
			}
		}
		//jquery，ajaix请求
		function request(url, method, dataObject, scuuessCallback, errorCallback) {
			var newurl = location.origin + '/dev-api' + url;
			method = method || "GET";
			$.ajax({
				type: method,
				url: newurl,
				async: false,
				data: JSON.stringify(dataObject),
				contentType: "application/json;charest=utf-8",
				dataType: "json",
				headers: {
					Authorization: 'Bearer' + $.cookie('Admin-Token')
				},
				success: function (data) {
					scuuessCallback(data);
				},
				error: function (e) {
					console.log("请求数据出错" + url + "。详见如下：");
					console.log(e);
					errorCallback(e);
				}

			})

		}
		//页面加载时，请求数据并绑定
		$(function () {
			request('jxgl/dv/summmary', null, null, function (response) {
				//success
				if (response.data && response.data.length > 0) {
					dv.summaryData = response.data[0];
					renderSummary();
				}
			}, function (e) {
				//error
			});

			request('jxgl/dv/course', null, null, function (response) {
				//success
				dv.deptParcentData = response.rows; renderDeptParcent();
			}, function (e) {//error
			});

			request('jxgl/dv/pinlv', null, null, function (response) {//success
				dv.scNumData = response.rows; if (dv.scNumData && dv.scNumData.length > 0) { renderTermScNum(dv.scNumData.length - 1); }
			}, function (e) {//error
			});

			request('jxgl/dv/errorWork', null, null, function (response) {//success
				dv.gzlTop5Data = response.rows.sort((a, b) => b.fail_rate - a.fail_rate).slice(0, 5);
				renderGzlTop5(); // 渲染排行榜
			}, function (e) { // 失败回调
				console.error('请求失败：', e);
			});

			request('jxgl/dv/score', null, null, function (response) {//success,null
				dv.scoreData = response.rows;
				if (dv.scoreData && dv.scoreData.length > 0) {
					renderAePercent();
				}
			}, function (e) { // 失败回调
				console.error('请求失败：', e);
			});

			request('jxgl/dv/theTermInfo/' + dv.theTerm, null, null, function (response) {//success
				if (response.total > 0) { dv.theTermInfo = response.rows[0]; renderTermInfo(); }
			}, function (e) {
				//error
			});

			request('jxgl/dv/stuPoint', null, null, function (response) {//success
				dv.pointTop50Data = response.rows; renderSpointTop50();
			}, function (e) {//error
			});
		});
	</script>

</body>

</html>